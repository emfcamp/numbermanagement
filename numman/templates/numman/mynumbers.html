{% extends 'base.html' %}
{% load static %}
{% block content_formatted %}
<div class="row">
<div class="col-12">
<h2>
 {% if title %}
 {{title}}
 {% endif %}
</h2>
 {% if description %}
<p>{{description}}</p>
 {% endif %}
</div>
</div>
<div class="row">
<form id="searchform">
<div class="col-9">
<input type="text" id="search"
class="wide"
oninput="searchAllTables()"
placeholder="Search the phonebook...">
</div>
<div class="col-3">
<input type="reset" class="wide" value="Clear Search">
</div>
<div class="col-12">
{% regroup numbers by event as events_list %}
{% for event in events_list %}
<div class="event-section">
<h3>{{ event.grouper|default:"No Event" }}</h3>
<table id="phonebook-{{ forloop.counter }}" class="phonebook sortable">
<tr data-sort-method='none'>
<th>Number</th>
<th>Label</th>
<th>Type</th>
<th data-sort-method='none'>Modify</th>
</tr>
{% for number in event.list %}
<tr>
<td><div class="col-12 center">{{ number.value }}</div></td>
<td><div class="col-12">{{ number.label }}</div></td>
<td><div class="col-12 center">{{ number.typeofservice }}</div></td>
<td class="inline-menu">
<div class="col-4 center">
<a href="/number/info/{{number.value}}" id="{{number.value}}">
<i class="fa-solid fa-gear"></i> Details
</a>
</div>
<div class="col-4 center">
<a href="/number/edit/{{number.value}}">
<i class="fa-solid fa-pen"></i> Modify
</a>
</div>
<div class="col-4 center">
<a href="/number/delete/{{number.value}}">
<i class="fa-solid fa-trash"></i> Delete
</a>
</div>
</td>
</tr>
{% endfor %}
</table>
</div>
{% endfor %}
</div>
</form>
</div>

<script src="{% static 'js/search.js' %}"></script>
<script>
// Initialize Tablesort for each table
{% for event in events_list %}
new Tablesort(document.getElementById('phonebook-{{ forloop.counter }}'));
{% endfor %}

// Modified search function to search across all tables
function searchAllTables() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    {% for event in events_list %}
    searchTable('phonebook-{{ forloop.counter }}', searchTerm);
    {% endfor %}
}

function searchTable(tableId, searchTerm) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length - 1; j++) { // Exclude last column (Modify)
            if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                found = true;
                break;
            }
        }
        
        row.style.display = found || searchTerm === '' ? '' : 'none';
    }
}
</script>

<style>
.event-section {
    margin-bottom: 2rem;
}

.event-section h3 {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}
</style>

{% endblock %}